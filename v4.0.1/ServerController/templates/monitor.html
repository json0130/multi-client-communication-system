<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor: Client</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 20px; background-color: #f0f2f5; color: #1c1e21;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header, .card { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .content { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .video-container { position: relative; background: #000; border-radius: 8px; overflow: hidden; aspect-ratio: 4/3; }
        #videoStream { width: 100%; height: 100%; object-fit: contain; }
        .emotion-display { 
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; 
            padding: 15px; border-radius: 8px; font-weight: bold; min-width: 200px;
        }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid; font-weight: bold; }
        .connected { background: #e8f5e8; border-color: #4caf50; color: #2e7d32; }
        .disconnected { background: #ffebee; border-color: #f44336; color: #c62828; }
        .connecting { background: #fff3e0; border-color: #ff9800; color: #ef6c00; }
        .chat-messages { 
            height: 300px; overflow-y: auto; border: 1px solid #ddd; 
            padding: 15px; margin: 15px 0; background: #fafafa; border-radius: 8px;
        }
        .message { margin: 10px 0; padding: 12px; border-radius: 8px; }
        .user-message { background: #e3f2fd; text-align: right; margin-left: 20%; }
        .bot-message { background: #f3e5f5; margin-right: 20%; }
        .system-message { background: #fff3e0; font-style: italic; text-align: center; margin: 5px 0; padding: 8px; }
        .debug-panel { 
            background: #f5f5f5; border: 1px solid #ddd; border-radius: 8px; 
            padding: 15px; margin: 15px 0; font-family: monospace; font-size: 12px; 
        }
        .debug-title { font-weight: bold; margin-bottom: 10px; color: #333; }
        .debug-line { margin: 2px 0; color: #666; }
        .emotion-value { font-size: 18px; margin: 5px 0; }
        .confidence-bar {
            width: 100%; height: 8px; background: #ddd; border-radius: 4px; 
            overflow: hidden; margin: 8px 0;
        }
        .confidence-fill { height: 100%; background: #4caf50; transition: width 0.3s ease; }
        @media (max-width: 1024px) {
            .content { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Monitor: <span id="clientIdTitle">CLIENT_ID</span></h1>
            <div id="connectionStatus" class="status connecting">üîÑ Connecting...</div>
        </div>
        
        <div class="content">
            <div class="card video-section">
                <h2>üì∫ Live Video Stream</h2>
                <div class="video-container">
                    <img id="videoStream" src="#" alt="Live Stream">
                    <div class="emotion-display">
                        <div>Emotion: <span id="emotionText">neutral</span></div>
                        <div class="emotion-value">
                            Confidence: <span id="confidenceText">0%</span>
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" id="confidenceFill" style="width: 0%;"></div>
                        </div>
                        <div style="font-size: 12px; margin-top: 8px;">
                            Last Update: <span id="lastUpdate">Never</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card info-section">
                <h2>‚ÑπÔ∏è Client Information</h2>
                <p><strong>Client ID:</strong> <span id="clientId">CLIENT_ID</span></p>
                <p><strong>Modules:</strong> <span id="enabledModules">Loading...</span></p>
                <p><strong>Status:</strong> <span id="clientStatus">Loading...</span></p>
                
                <h2>üí¨ Live Chat</h2>
                <div class="chat-messages" id="chatMessages">
                    <div class="system-message">Waiting for chat messages...</div>
                </div>
            </div>
        </div>
        
        <div class="debug-panel">
            <div class="debug-title">üîç Connection Debug</div>
            <div id="debugOutput">Initializing...</div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        console.log('üöÄ Starting enhanced monitor script...');
        
        // Configuration - these can be set dynamically or via URL parameters
        let CLIENT_ID = "{{client_id}}";
        let ENABLED_MODULES = JSON.parse('{{enabled_modules_json}}');
        
        // Update UI with client information
        document.getElementById('clientIdTitle').textContent = CLIENT_ID;
        document.getElementById('clientId').textContent = CLIENT_ID;
        
        console.log('üìã Client ID:', CLIENT_ID);
        console.log('üéØ Enabled Modules:', ENABLED_MODULES);
        
        // Set video stream source
        document.getElementById('videoStream').src = `/client/${CLIENT_ID}/live_stream`;
        
        // Debug output function
        function addDebugLine(message) {
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            const newLine = document.createElement('div');
            newLine.className = 'debug-line';
            newLine.textContent = `[${timestamp}] ${message}`;
            debugOutput.appendChild(newLine);
            
            // Keep only last 10 debug lines
            while (debugOutput.children.length > 10) {
                debugOutput.removeChild(debugOutput.firstChild);
            }
            
            console.log('üîç DEBUG:', message);
        }
        
        // Update connection status
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            const clientStatusElement = document.getElementById('clientStatus');
            
            statusElement.className = `status ${status}`;
            
            switch(status) {
                case 'connected':
                    statusElement.innerHTML = '‚úÖ Connected';
                    clientStatusElement.textContent = 'Active';
                    break;
                case 'disconnected':
                    statusElement.innerHTML = '‚ùå Disconnected';
                    clientStatusElement.textContent = 'Offline';
                    break;
                case 'connecting':
                    statusElement.innerHTML = 'üîÑ Connecting...';
                    clientStatusElement.textContent = 'Connecting';
                    break;
                case 'error':
                    statusElement.innerHTML = `‚ùå Error: ${message}`;
                    clientStatusElement.textContent = 'Error';
                    break;
            }
        }
        
        addDebugLine('Initializing Socket.IO connection...');
        
        // Socket.IO connection
        const socket = io(window.location.origin + '/monitor', {
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5,
            timeout: 20000,
            forceNew: true
        });
        
        // Connection event handlers
        socket.on('connect', function() {
            addDebugLine('Connected to /monitor namespace');
            updateConnectionStatus('connecting', 'Joining client room...');
            
            // Join the client room
            addDebugLine(`Joining room for client: ${CLIENT_ID}`);
            socket.emit('join_client_room', { client_id: CLIENT_ID });
        });

        socket.on('disconnect', function(reason) {
            addDebugLine(`Disconnected: ${reason}`);
            updateConnectionStatus('disconnected', reason);
        });
        
        socket.on('connect_error', function(error) {
            addDebugLine(`Connection error: ${error.message}`);
            updateConnectionStatus('error', error.message);
        });

        socket.on('reconnect', function(attempt) {
            addDebugLine(`Reconnected after ${attempt} attempts`);
        });

        socket.on('reconnect_error', function(error) {
            addDebugLine(`Reconnection error: ${error.message}`);
        });

        // Room join confirmation
        socket.on('room_joined', function(data) {
            addDebugLine('Successfully joined client room');
            updateConnectionStatus('connected', 'Monitoring active');
            
            console.log('üìã Room join data:', data);
            
            // Update client info if available
            if (data.current_emotion) {
                document.getElementById('emotionText').textContent = data.current_emotion;
            }
            if (data.current_confidence !== undefined) {
                updateConfidence(data.current_confidence);
            }
            if (data.enabled_modules) {
                ENABLED_MODULES = data.enabled_modules;
                document.getElementById('enabledModules').textContent = ENABLED_MODULES.join(', ');
            }
        });

        // Error handling
        socket.on('error', function(data) {
            addDebugLine(`Server error: ${data.message}`);
            updateConnectionStatus('error', data.message);
        });

        // Frame update handler
        socket.on('client_frame_update', function(data) {
            addDebugLine(`Frame update: ${data.emotion} (${data.confidence}%)`);
            
            console.log('üì∏ Frame update received:', data);
            
            if (data.emotion) {
                document.getElementById('emotionText').textContent = data.emotion;
            }
            if (data.confidence !== undefined) {
                updateConfidence(data.confidence);
            }
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        });

        // Chat message handler
        socket.on('client_chat_message', function(data) {
            addDebugLine(`Chat message: ${data.type} - ${data.content.substring(0, 30)}...`);
            addChatMessage(data);
        });

        // Client connection status updates
        socket.on('client_connected', function(data) {
            addDebugLine(`Client connected: ${data.robot_name || 'Unknown'}`);
            updateConnectionStatus('connected', 'Client active');
        });

        socket.on('client_disconnected', function(data) {
            addDebugLine('Client disconnected');
            updateConnectionStatus('disconnected', 'Client offline');
        });

        // Utility functions
        function updateConfidence(confidence) {
            const confidenceText = document.getElementById('confidenceText');
            const confidenceFill = document.getElementById('confidenceFill');
            
            if (confidenceText) {
                confidenceText.textContent = Math.round(confidence) + '%';
            }
            
            if (confidenceFill) {
                confidenceFill.style.width = confidence + '%';
                
                // Update color based on confidence level
                if (confidence > 70) {
                    confidenceFill.style.backgroundColor = '#4caf50'; // Green
                } else if (confidence > 40) {
                    confidenceFill.style.backgroundColor = '#ff9800'; // Orange  
                } else {
                    confidenceFill.style.backgroundColor = '#f44336'; // Red
                }
            }
        }

        function addChatMessage(data) {
            const chatContainer = document.getElementById('chatMessages');
            
            // Remove "waiting" message if it exists
            const waitingMessage = chatContainer.querySelector('.system-message');
            if (waitingMessage && waitingMessage.textContent.includes('Waiting for')) {
                waitingMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (data.type === 'user' ? 'user-message' : 'bot-message');
            
            const author = data.type === 'user' ? 'User' : 'Bot';
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                    <strong>${author}</strong> ‚Ä¢ ${timestamp}
                    ${data.emotion ? ` ‚Ä¢ ${getEmotionEmoji(data.emotion)}` : ''}
                </div>
                <div>${data.content}</div>
            `;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function getEmotionEmoji(emotion) {
            const emojis = {
                'happy': 'üòä',
                'sad': 'üò¢', 
                'angry': 'üò†',
                'fear': 'üò®',
                'surprise': 'üò≤',
                'disgust': 'ü§¢',
                'contempt': 'üò§',
                'neutral': 'üòê'
            };
            return emojis[emotion] || 'üòê';
        }

        // Video stream error handling
        document.getElementById('videoStream').onerror = function() {
            console.error('‚ùå Video stream failed to load');
            addDebugLine('Video stream error - check if emotion module is enabled');
            this.alt = 'Video stream unavailable';
        };

        document.getElementById('videoStream').onload = function() {
            addDebugLine('Video stream loaded successfully');
        };

        // Ping to keep connection alive
        setInterval(function() {
            if (socket.connected) {
                socket.emit('ping', { client_id: CLIENT_ID });
            }
        }, 30000); // Every 30 seconds

        // Initial setup complete
        addDebugLine('Monitor script initialized successfully');
        console.log('‚úÖ Enhanced monitor script loaded successfully');
    </script>
</body>
</html>